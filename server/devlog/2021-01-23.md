# 2021 01 23
* 프로젝트 생성 API 제작
* 프로젝트 명단 API 제작
## API 제작
CICD구축은 클라이언트와의 레포 분리 이후에 하기로 했다. 프론트엔드 분들과 같이 있을 때 레포 분리하고 진행하려 한다.

그래서 오늘은 코드 작업에 들어갔다. 그동안 도커에만 너무 집중해서 그런지 뭘 만들어야하는지 잘 기억이 나질 않았다. 여기서 문서화의 중요성을 느꼈다. 

프로젝트의 경우 생성하고 생성한 유저에게 `editor permission`을 주어야한다. `users`테이블과 `projects`테이블의 관계를 나타내는 `project_permissions`테이블에도 값을 삽입해야하는데 이를 어떻게 처리해야하는지 리서치가 필요하다. 

일단 repository를 사용하기로 했다. 유저 관련 API를 작성할 때 사용하지 않아서.. 이번에 처음 사용해보게 되었다. 파일이름을 뭐로 해야하는지, 그리고 어떻게 선언하는지 파악하면 users API에서도 이처럼 사용해주려 한다. (이전 생각해보니 로그인에서 findorcreate가 없으면 여기서 만들면 되지 않았을까 생각해봤다. )

repository를 사용하니 사용해야하는 메소드들을 딱 정할 수 있어서 좋았다. 이 함수는 왜 사용하는지 명시하는 느낌이 들었다. 하지만 동시에 두 테이블에 값을 넣고 싶은데 그 방법을 모르겠다. 지금 하는 작업처럼 유저가 프로젝트를 생성하는 경우 `projets`, `project_permissions`두 테이블에 값을 다 넣어야 한다. 이를 한 레포지토리 파일에서 선언해주고 싶은데 가능한지, 그리고 이렇게 하면 문제가 없는지 고민이 된다. 

`project_permission` 테이블의 레포지토리를 만들었다. 여기서 `userid`, `projectid`를 넣어주려고 했지만 타입이 다르다는 에러가 나왔다. (typescript 사랑해요) 

레포지토리 파일 안에서 레포지토리를 사용하면 어떨까? 하는 생각이 들었지만 스파케티 코드의 시작점이 될거같아 그렇게 하지 않기로 했다. 레포지토리 파일은 각 `entity`에 종속되게 만들고, 만들어진 레포지토리 파일들은 controller에서 사용하게끔 했다. 

진행하면서 로그인한 유저의 정보를 받아오는 코드를 작성해주었다. 생각해보니 많은 부분에서 이 코드를 사용해야하고 중복될 것 같다는 생각이 들었다. (이미 중복되긴 했다.) 이 코드를 함수화 해서 분리하는게 좋을지 고민이 필요하다. 전에 이렇게 하다 코드가 꼬인적 있어서 조심하게 된다. 

타입스크립트에 점점 익숙해져간다. 처음에는 any를 많이 사용했는데 지금은 자동완성기능을 사용하기 위해 함수의 타입을 지정하고 있는 자신을 발견했다. 

일단 프로젝트를 생성하는 API는 완성했다. 하지만 제대로 생성했는지 확인이 잘 되지 않는다 테스트케이스를 작성하면 되겠지만 도커로 바꿔준 탓인지 다시 테스트케이스를 작성해줘야하는 상황이다. 일단 프로젝트 중반쯤 다시 테스트 코드를 작성할 예정이다. (아마 배포 -> 테스트코드 작성 -> CICD순으로 진행하지 않을까 싶다.)

제대로 생성됬는지 확인하기위해서 이제는 로그인한 유저가 들어가있는 프로젝트의 명단을 받아오는 API를 작성해주려 한다. 

프로젝트 생성때 작성해준 파일들을 바탕으로 작성해주었다. 하지만 500에러가 발생했고 왜 이 에러가 발생했는지 파악해야한다. 에러를 처리하는 방법이 있었으면 좋겠다. 에러가 발생한다면 어떤 에러가 왜 발생했는지 디스코드나 슬랙같은 커뮤니케이션 툴로 알려주도록 한번 해주고 싶다. 

콘솔로 찍어주었다. 단순한 jwt 토큰 파기에 대한에러였다. 이 에러에 대한 핸들링이 필요하다. 추후 jwt를 uuid로 변경하는 함수를 만들면서 이 에러를 핸들링하는 부분을 추가해줘야겠다. 

처음에는 간단하게 `project_permissions` 테이블에서 조인하면 되는줄 알았는데 확인해보니 프로젝트의 id만 받아와졌다. 유저가 가지고 이는 프로젝트가 어떤 프로젝트인지 하나도 나오지 않았다. 그래서 처음으로 테이블 조인을 하게 되었다. 어떻게 하는지 검색해보니 쿼리 빌더라는 것이 있어 확인해봤다.

처음에는 `project_permissions의` 레포지토리파일에 선언하면 될줄 알았다. 하지만 쿼리빌더를 확인해보니 어디에 넣어야하는지 잘 모르겠다. 

현재 로그인한 유저의 "프로젝트"들을 받아오는 API이기 때문에 `projects` 레포파일에서 작성하기로 했다. 반환타입이 뭔지 고민하다보니 이런 결과가 나오게 되었다. 

생각보다 쿼리빌더가 어렵게 느꺄졌다. 오히려 SQL문으로 하면 금방 끝났을텐데.. 라는 생각이 계속들었다. 

일단 쿼리빌더를 통해 API를 만들어주었다. 에러가 발생했는데 200이 들어왔다. 여기에도 에러핸들러가 필요하다. 

leftjoin대신 서브쿼리를 사용하여 해결해주었다. 

그럼 이제 문제가 생긴다. 지금은 프로젝트의 정보들만 받아온다. 하지만 내가 필요한건 로그인한 유저의 프로젝트들과 허용된 권한까지 원한다. 즉 결국 leftjoin이 필요하다는 것을 다시 알게 되었다. 

leftjoin을 사용하여 해결해주었다. 이해하고나니 이제는 조금 쉽게 느껴졌다. (이게 sequelize보다 typeorm이 더 좋은 점중 하나라고 생각한다)
