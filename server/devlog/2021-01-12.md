# 2021 01 12 

* 테스트 케이스 작성



## Test Case

테스트 케이스를 작성해보려고 한다. 내가 작성한 코드의 최소한의 보증수표이자 console.log의 자동화일환으로 작성하게 되었다. mocha와 chai를 사용하려고 한다. jest가 무겁다는 이야기를 많이 들었고, 수강생때 mocha와 chai로 이루어진 코드를 많이 봤기때문에 선택하게 되었다. 

어떤 테스트케이스를 작성해줘야하는지 잘 모르겠다. 내가 작성한 파일마다 테스트케이스가 있어야하는지, 하나의 기능별로 있어야하는지, 서버와 데이터베이스를 모두 아우르는 테스트케이스를 작성해야하는지, 서버따로 데이터베이스 따로 테스트케이스를 작성해야하는지...

일단 서버와 데이터베이스를 모두 아우르고, 기능별로 테스트케이스를 작성해주기로 했다. 기능별이란 로그인, 회원가입 같이 하나의 기능을 의미한다. 서버, 데이터베이스를 나누지 않은 이유는 일단 내가 작성한 모든 코드가 잘 맞물려 돌아가는지 확인하기 위함이었다. 물론 유닛단위 테스트로 서버, 데이터베이스를 나누고 더 잘게 코드를 나누어 테스트하면 좋겠지만 아직 한번도 테스트케이스를 나눠보거나 작성하지 않아서 어떻게 해야하는지 감이 잘 오지 않았다. 일단 해보기로했다. 

그래서 먼저 작성하게된 테스트케이스는 어제 구현한 회원가입에 대한 테스트케이스이다. 

3가지 케이스에 대해서 작성해주었다. '정상적으로 잘 작동하는 경우', '같은 내용으로 가입하려 하는경우', '잘못된 값으로 가입하려하는경우' 이 3가지를 넣어주었다.

테스트를 실행하다보니 2가지의 문제가 발생했다. 정상적으로 들어가야하는 테스트케이스의 경우 실행하기 전 데이터베이스에 저장된 내용을 지우지 않으면 테스트케이스가 통과되지 않는다. 그리고 테스트가 끝난 뒤에도 서버가 열려있었다. 

먼저 두번째 문제부터 해결이 되었다. `npm test` 에 `"test": "mocha -r ts-node/register ./**/*.test.ts"` 와 같이 작성되어있었는데 이를 `"test": "mocha -r ts-node/register ./**/*.test.ts --exit"` 이렇게 수정해주었다. 마지막에 --exit을 넣어줌으로써 테스트가 끝나면 종료하도록 해주었다.

첫번재 문제는 테스트가 시작하기 전, 또는 시작할 때 해당하는 row를 지우도록 해줘야겠다는 생각이들었다. 

위 방법대로 하니 정상적으로 작동이되고 모든 테스트케이스가 통과되는 것을 확인할 수 있었다. 추가적으로 typeORM의 find 조건을 잘못걸어주어 정상적으로 작동하고 있지 않다는 사실을 알게되었다. 테스트케이스의 덕을 조금 본 것 같았다. 

여기서 문제를 발견할 수 있었다. 현재 내가 작성한대로라면  테스트를 할 때마다 데이터베이스의 PK가 늘어난다는 점이었다. 
테스트를 할 때만 사용할 수 있는 데이터베이스가 필요했다. 그래서 Test전용 데이터베이스를 만들어주었다.

truncate를 활용하고 싶었지만 외래키의 연결로 되지 않았다. 이 부분에 대한 해결책은 일단 다음으로 미루었다. 

오늘은 이렇게 API 테스트 케이스를 만들어보았다. 아직 이 방법이 맞는지는 정확하게 모르겠다. 더 효율적인 방법, 더 좋은 방법이  있을 것 같다. 내일 다른 API를 만들면서 더 발전할 수 있으면 좋겠다.

