# 2020 01 15

* ~~docker 빌드, 배포~~
* 로그인 기능 추가
* 로그인 기능 테스트 코드 작성



## docker 

처음 도커를 사용해보았다. 프로젝트의 한 기능이 완성되었고 테스트 코드도 작성하여 이제 배포를 해보려고 한다. docker를 사용하여 배포에서 실행환경에 따른 문제를 발생시키지 않으려고 했다. (사실 아직 도커에 대해서 이해하지 못했다. 이미지를 만들어서 빌드하고 배포한다! 가상환경처럼 사용이 가능하다! 라는 이야기만 듣고 아! 그렇구나! 라는 상태이다. 조금 자세한 사항을 공부하여 블로깅해야겠다. )

일단 도커를 설치한 뒤 Dockerfile을 만들어주었다. .dockerignore파일도 만들어주었고 node_modules와 npm-debug.log를 추가해 Docker 이미지에 로컬 모듈과 디버깅 로그를 복사하는 것을 막아서 이미지 내에서 설치한 모듈을 덮어쓰지 않게 하였다.

도커파일로 빌드를 해주었다. 그리고 실행해주었다. 당연하게도(?) 실행이 되지 않았고 `Cannot use import statement outside a module` 는 에러가 발생했다. `package.json`에 `"type": "module" ` 을 설정해주어 에러를 해결해주었다. (Package.json에 대해서 공부가 필요하다.)

다시 빌드하고 실행해주니 (생각보다 번거로웠다. 이것도 자동화가 가능할까? 예를 들면 푸쉬할 때 마다 빌드한다던지.. 허스키를 더 알아봐야겠다.) `[ERR_UNKNOWN_FILE_EXTENSION]: Unknown file extension ".ts" for /usr/src/app/src/index.ts` 라는 에러가 발생했다. 이번에는 `"type": "module"`을 설정해서 발생한 문제라고 한다... 타입스크립트파일을 그냥 빌드해서 생긴 문제가 아닌가? 라는 생각이 들었다. 

도커 명령어들을 찾아서 Dockerfile을 변경해주었다. typescript를 전역으로 설치하고 cmd명령어를 `package.json`의 script에 맞게 변경해주었다. 서버가 실행이 되었지만 `connect ECONNREFUSED` 라는 에러가 발생했다. Mysql 연결실패에 대한 에러라는 것을 확인한 뒤 환경변수에서 문제가 발생한건 아닌가? 라는 생각이 들어 관련으로 리서치해주었다. 도커파일안에서 환경변수를 선언할 수 있다는 것을 알게되었고 바로 추가해주었다. `.gitignore`파일에 `Dockerfile`을 추가해주었다. 그럼에도 불구하고 에러가 발생했다. 환경변수가 설정이 안됬는지 확인해주기 위해 Console.log로 찍어보았지만 잘 나왔다. 환경변수가 아닌 다른 문제로 보였다. 지금 추측할 수 있는 경우는 1. Mysql 초기세팅에서 외부접속을 차단했기 때문에 안된다. 2. 만든 도커 이미지의 localhost와 내 맥북 localhost가 달라서 생기는 문제다 이 두가지로 생각해볼 수 있었다. 

여러가지의 케이스를 가정하고 리서치해봤다. (2시간 정도 걸린것 같았다. ) 아직 해결방안을 찾지 못했다. mysql세팅에서 외부접속을 해지해볼까? 했지만 일단 보류했다. (데이터베이스로 털리는 것을 본적이 많아 로컬 데이터베이스는 외부접속을 가능하면 열고 싶지 않았다.) 일단 docker는 배포를 위한 목적으로 사용하는 것이기 때문에 지금단계에서 배포를 해봐도 괜찮을 것 같다는 생각이 들었다. 

일단 보류하고 진행하기로 했다. https설정과 기본적인 유저 로그인, 로그아웃, 회원탈퇴까지 진행하고 배포하면서 cicd환경까지 구축할 예정이다. 



## 로그인

이전에 만들었던 회원가입 기능을 토대로 제작해주었다. jwt를 사용하여 로그인에 성공한 경우 토큰을 발급받을 수 있도록 해주었다. 파기는 1시간이 지나면 토큰이 파기되도록 제작해주었다. (이부분은 팀원과 추후에 논의를 추가로 해주려고 한다.)

jwt에서 사용하는 토큰의 시크릿 키는 .env에서 설정해주었다. (점차 사용하는 환경변수의 수가 많아지고 있다. 이를 효율적으로 관리할 방법을 찾아봐야겠다.) 



## 로그인 테스트코드

로그인의 테스트코드 역시 회원가입의 테스트코드를 바탕으로 작성해주었다. 테스트데이터베이스를 매 태스트할 때 마다 초기화해줘야되서 이에 대해서 코드를 작성해주었다. 

Rowdatapacket에서 length를 사용할 수 없어서 이를 해결해주었다. (JSON, promise를 사용해서 해결해주었다.)

테스트코드에서는 typeorm을 사용하지 않고 데이터베이스에 접근한다. 하지만 이렇게 하니 코드가 복잡해지고 중복이 많아졌다. 이를 해결하기위해 테스트코드에서도 typeorm을 사용할 수 있는 방법을 찾아야겠다. 접근해야하는 데이터베이스가 다르므로 한 프로젝트에서 여러개의 typeorm config를 할 수 있는 방법을 찾아야겠다. 

테스트 코드를 작성하고 통과하는 모습을 확인했다. 